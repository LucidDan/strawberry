---
title: Channels
---

# Channels

Strawberry provides support for [Channels](https://channels.readthedocs.io/)
with
[Consumers](https://channels.readthedocs.io/en/stable/topics/consumers.html) to
provide GraphQL support over WebSockets and HTTP.

While Channels does require Django to be installed as a dependency, you can
actually run this integration without using Django's request handler. However
the most common use case will be to run a normal Django project with GraphQL
subscriptions support, typically taking advantage of the Channel Layers
functionality which is exposed through the Strawberry integration.

## Getting Started

Before using Strawberry's Channels support, make sure you install all the
required dependencies by running:

```
pip install 'strawberry-graphql[channels]'
```

The example below assumes you've already got a working Django project, having
followed the
[installation instructions](https://channels.readthedocs.io/en/stable/installation.html)
for Channels, and while not absolutely required, you probably want to also have
set up Django integration for Strawberry by following the
[documentation here](../integrations/django.md).

The easiest way to use Channels with Strawberry is to use the
GraphQLProtocolTypeRouter, which will wrap your Django application, and route
HTTP and websockets for /graphql to Strawberry, while sending all other requests
to Django. You'll need to modify the `myproject.asgi.py` file from the Channels
instructions to look something like this:

```python
import os

from django.core.asgi import get_asgi_application
from strawberry.channels import GraphQLProtocolTypeRouter

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'mysite.settings')
django_asgi_app = get_asgi_application()

# Import your Strawberry schema after creating the django ASGI application
# This ensures django.setup() has been called before any ORM models are imported
# for the schema.
from mysite.graphql import schema


application = GraphQLProtocolTypeRouter(
    schema,
    django_application=django_asgi_app,
)
```

The above code is not very flexible, taking away some of the useful capabilities
of Channels. For more complex deployments, you'll most likely want to read on
further...

## Custom ProtocolTypeRouter

A more complex use case is when you want to integrate several ASGI applications
on different URLs and protocols, like what is described in the
[Channels documentation](https://channels.readthedocs.io/en/stable/topics/protocols.html).

An example of this would be:

```python
import os

from django.core.asgi import get_asgi_application
from django.urls import re_path
from strawberry.channels import GraphQLWSConsumer, GraphQLHTTPConsumer
from channels.routing import ProtocolTypeRouter, URLRouter
from channels.auth import AuthMiddlewareStack

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'mysite.settings')
django_asgi_app = get_asgi_application()

# Import your Strawberry schema after creating the django ASGI application
# This ensures django.setup() has been called before any ORM models are imported
# for the schema.
from mysite.graphql import schema
from third_party import third_party_asgi_app
from multichat import ChatApp

application = ProtocolTypeRouter({
    "http": URLRouter([
        re_path("^graphql", AuthMiddlewareStack(GraphQLHTTPConsumer.as_asgi(schema=schema))),
        re_path("^api", django_asgi_app),
        # This might be eg a static file server or something
        re_path("^", third_party_asgi_app),
    ]),
    "websocket": URLRouter([
        re_path("^graphql", AuthMiddlewareStack(GraphQLWSConsumer.as_asgi(schema=schema))),
        re_path("^chat", ChatApp.as_asgi()),
    ]),
})
```

This example demonstrates some ways that Channels can be set up to handle
routing. A very common scenario will be that you want user and session
information inside the GraphQL context, which the AuthMiddlewareStack wrapper
above will provide. It might be apparent by now, there's no reason at all why
you couldn't run a Channels server without any Django ASGI application at all.
However, take care to ensure you run `django.setup()` instead of
`get_asgi_application()`, if you need any Django ORM or other Django features in
Strawberry.

## Channel Layers

The Context for Channels integration includes the consumer, which has an
instance of the channel layer and the consumer's channel name. Here's an example
of how this can be used in the schema to provide subscriptions to events
generated by background tasks or the web server, even if these are executed in
other threads, processes, or even other servers if you are using a Layer backend
like Redis or RabbitMQ.

To set this up, you'll need to make sure Channel Layers is configured as per the
[documentation](https://channels.readthedocs.io/en/stable/topics/channel_layers.html).

Then you'll want to add a subscription that accesses the channel layer and joins
one or more broadcast groups.

Since listening for events and passing them along to the client is a common use case,
the base consumer provides a high level API for that using a generator pattern.

For example, a basic chat room implementation might look like this:

```python

from typing import AsyncGenerator

from channels.layers import get_channel_layer
import strawberry
from strawberry.channels import StrawberryChannelsContext
from strawberry.types import Info


@strawberry.input
class ChatRoom:
    id: str


@strawberry.type
class ChatRoomMessage:
    id: str
    message: str


@strawberry.type
class Mutation:
    @strawberry.mutation
    async def send_chat_message(
        self,
        room: ChatRoom,
        message: str,
    ):
        channel_layer = get_channel_layer()
        await channel_layer.group_send(
            f"chat-room-{room.id}",
            {
                "type": "chat.message",
                "room_id": room.id,
                "message": message,
            }
        )


@strawberry.type
class Subscription:
    @strawberry.subscription
    async def join_chat_rooms(
        self,
        info: Info[StrawberryChannelsContext],
        rooms: list[ChatRoom],
    ) -> AsyncGenerator[ChatRoomMessage, None]:
        """Join and subscribe to messages sent to the given rooms."""
        ws = info.context.request
        rooms = [f"chat-room-{room.id}" for room in rooms]

        channel_layer = ws.channel_layer
        for group in channel_layer.groups:
            await channel_layer.group_send(
                group,
                {
                    "type": "chat.message",
                    "room_id": group.split("-")[-1]
                    "message": f"{self.channel_name} just joined the room!",
                },
            )

        async for message in ws.channel_listen("chat.message", groups=rooms):
            yield ChatRoomMessage(
                id=message["room_id"],
                message=message["message"],
            )
```

Look here for some much more complete examples:

1. The
   [Strawberry Examples repo](https://github.com/strawberry-graphql/examples)
   contains a basic example app demonstrating subscriptions with Channels.
